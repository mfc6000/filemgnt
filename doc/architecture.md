**架构图与模块划分**

*整体拓扑（文字说明）*  
- **前端（Web & Mobile）**：Vue3 + Vite + TypeScript，配合 Pinia、Vue Router 与 Arco Design。通过 HTTPS 调用后端 REST API，支持文件上传、仓库管理、标签设置、全文搜索结果展示。  
- **后端（Node.js + Express）**：提供鉴权、用户管理、仓库管理、文件上传、标签管理、搜索代理等 REST API。后台调用 LowDB（可后续替换为持久化数据库）记录用户、仓库、文件元数据与标签。处理上传文件，推送至对象存储，并通过 Dify 接口同步知识库。  
- **存储层**  
  - **LowDB**：轻量 JSON 数据库，记录用户信息、仓库结构、文件元数据、标签。后续可替换为 MongoDB/PostgreSQL。  
  - **文件对象存储**：本阶段可使用本地文件系统，未来可替换为 S3、OSS 等。  
- **Dify 知识库**：后端在文件上传或更新时调用 Dify API，同步文档，实现全文搜索、问答支持。后端统一封装搜索请求并返回给前端。  
- **容器化部署**  
  - Docker-compose 启动前端、后端、LowDB（或挂载卷）以及必要的反向代理。  
  - 环境变量管理第三方 API 密钥、管理员配置等。

**模块划分**

1. **前端模块**
   - 登录/鉴权页面（初期用 mock token）  
   - 管理面板（用户管理、仓库列表）  
   - 用户仓库视图（文件列表、标签、搜索）  
   - 文件上传页面/弹窗（含标签 share）  
   - 搜索结果页面（调用后端搜索接口）

2. **后端模块**
   - 鉴权模块（暂时 mock，后续扩展 JWT/OAuth）  
   - 用户管理（增删改查）  
   - 仓库管理（创建/删除/获取）  
   - 文件上传与管理（保存文件、记录元数据、标签 share 标记）  
   - Dify 同步模块（文档入库、全文搜索 API）  
   - 管理员权限控制（读取所有文件、日志）

3. **存储模块**
   - LowDB：用户信息表、仓库表、文件表、上传日志表  
   - 文件对象存储：文件实体  
   - 缓存层（可选，后续用于搜索加速）

4. **Dify 对接模块**
   - 文件上传后处理：调用 Dify Knowledge Base API，传入文件路径/内容、标签  
   - 搜索：接收前端关键词，调用 Dify 搜索接口，返回结构化结果  
   - 错误处理与重试机制

**数据流**

1. **文件上传流程**
   1. 用户登录后选择仓库并上传文件（含 share 标签）。  
   2. 前端调用后端上传 API，携带用户 token、仓库信息、标签。  
   3. 后端验证用户权限，保存文件到对象存储，写入元数据到 LowDB。  
   4. 后端异步或同步调用 Dify 知识库 API，上传文件内容或链接，完成入库。  
   5. 返回上传结果、文档 ID、入库状态给前端。

2. **全文搜索流程**
   1. 用户在前端输入关键词。  
   2. 前端调用后端搜索 API。  
   3. 后端校验用户权限。  
   4. 后端调 Dify 知识库搜索接口，附带用户 ID、仓库上下文、share 标签过滤。  
   5. Dify 返回匹配文档与片段。  
   6. 后端根据用户权限进一步过滤，返回给前端。  
   7. 前端展示搜索结果，支持跳转到对应文件或内容摘要。

3. **鉴权流程（Mock）**
   1. 登录页面输入用户名/密码（前期可直接选择用户）。  
   2. 前端发送登录请求，后端返回模拟 token（内含用户角色、ID）。  
   3. 前端把 token 保存到 Pinia/LocalStorage，用于后续 API 调用。  
   4. 后端在 API 层解析 token，校验权限（管理员、普通用户）。  
   5. 后续计划替换为真实的认证体系。

**范围边界**

- 不支持匿名分享链接，所有访问需登录。  
- 不实现自助注册流程，由管理员添加/管理用户。  
- 鉴权逻辑先采用 mock token，后续再接入真实认证方案。  
- 高级审计、版本管理、外链分享、实时协作等暂不覆盖。

**验收清单**

- **用户管理**：管理员可以通过 Web 后台新增、编辑、删除用户，并能重置基础信息。
- **仓库管理**：登录用户可查看自己的仓库列表并创建新仓库，名称需校验唯一性。
- **文件上传**：支持 PDF、图片、TXT、Markdown、Office（三件套）等常见格式的上传，含大小校验与错误提示。
- **Share 标记**：上传时可切换 `share=true/false`，列表中可区分共享状态。
- **管理员浏览**：管理员可在统一视图浏览全部文件并按仓库/用户筛选。
- **全文搜索**：前端调用 `/api/search` 查看 Dify 或本地索引返回的匹配结果。
- **移动端适配**：关键页面（登录、仓库、上传、搜索、管理员）在手机视口上保持可用布局与触控交互。


**后续步骤清单（示例 9 步）**

1. 需求拆解与用户角色确认  
2. 接口协议与数据模型设计  
3. 前端项目初始化与基础布局搭建  
4. 后端项目初始化与 mock 鉴权实现  
5. 用户管理与仓库 API 开发  
6. 文件上传、标签管理、对象存储对接  
7. Dify 知识库集成（上传同步 + 搜索代理）
8. 前端文件管理与搜索界面实现
9. Docker 化配置与部署验证

**升级建议**

- **鉴权强化**：将 mock token 升级为 JWT/OIDC，增加刷新令牌与权限颗粒度控制。
- **云存储**：替换本地 `uploads/` 为云对象存储（S3、OSS 等），提升可用性与容量。
- **列表性能**：为用户、仓库、文件接口提供分页、排序与预览缩略图，改善大数据量体验。
- **安全加固**：增加病毒扫描、MIME 深度校验、速率限制、审计日志与最小权限配置。
- **CI/CD**：引入自动化测试、Lint、容器镜像扫描与多环境部署流水线。

